= API Endpoints
:toc:
:toc-title: Table of Contents
:toclevels: 2

This document describes the API endpoints available in the provisioner-service. These endpoints can be used for integration with other systems, building custom dashboards, or automating operations.

The API documentation is organized into the following sections. Click on any section to view the detailed documentation.

== Core API Sections

=== link:api/manufacturing.adoc[Manufacturing Database API]

Access device provisioning records and manufacturing data collected during the provisioning process. Provides pagination support and detailed device information including hardware specifications, security settings, and provisioning timestamps.

**Key Endpoints:**

* `GET /api/v2/manufacturing` - Retrieve manufacturing database records with optional filtering

**Use Cases:** Building custom dashboards, integration with inventory systems, quality assurance tracking

---

=== link:api/devices.adoc[Devices API]

Monitor and manage devices during provisioning, including access to device logs and cryptographic keys. Provides detailed information about device state, IP addresses, and USB topology.

**Key Endpoints:**

* `GET /devices` - List all devices
* `GET /devices/{serialno}` - Get device details
* `GET /devices/{serialno}/log/{type}` - Retrieve device logs (provisioner, bootstrap, triage)
* `GET /devices/{serialno}/key/public` - Download public key
* `GET /devices/{serialno}/key/private` - Download private key (DISABLED BY DEFAULT - see security documentation)

**Use Cases:** Real-time device monitoring, log retrieval for troubleshooting, key management

[CAUTION]
====
The private key download endpoint is disabled by default for security reasons. See the Devices API documentation for details on the security configuration required to enable it.
====

---

=== link:api/customisation.adoc[Customisation API]

Full CRUD (Create, Read, Update, Delete) operations for managing customisation scripts that hook into various provisioning stages. Scripts can customize device configuration during bootstrap, filesystem mounting, and post-flash stages.

**Key Endpoints:**

* `GET /customisation/list-scripts` - List all scripts and hook points
* `GET /customisation/get-script` - Retrieve script content
* `POST /customisation/save-script` - Create or update scripts
* `POST /customisation/upload-script` - Upload script files
* `POST /customisation/enable-script` - Enable script execution
* `POST /customisation/disable-script` - Disable script execution
* `POST /customisation/delete-script` - Delete scripts
* `GET /customisation/list-hooks` - List all available hook points
* `GET /customisation/create-script` - Get template for new scripts

**Use Cases:** Automated device customisation, deployment-specific configuration, fleet management

---

=== link:api/qrcode.adoc[QR Code Verification API]

Verify QR codes against the manufacturing database for device validation and quality control during the scanning process.

**Key Endpoints:**

* `POST /api/v2/verify-qrcode` - Verify if a QR code exists in the manufacturing database

**Use Cases:** Barcode scanner integration, mobile app validation, quality control workflows

---

=== link:api/services.adoc[Services API]

Monitor provisioning services running on the system, retrieve service logs with pagination, and track service execution history through systemd journal integration.

**Key Endpoints:**

* `GET /api/v2/services` - List all provisioning services
* `GET /api/v2/service-log/{name}` - Retrieve service logs with pagination

**Use Cases:** Service monitoring, troubleshooting provisioning issues, historical service analysis

---

=== link:api/images.adoc[Images API]

Complete lifecycle management of OS images including upload, download, metadata retrieval, and asynchronous SHA256 hash calculation with real-time progress updates.

**Key Endpoints:**

* `GET /get-images` - List all available images
* `GET /get-image-metadata` - Get image metadata (size, modification time, etc.)
* `GET /get-image-sha256` - Calculate or retrieve SHA256 hash
* `POST /upload-image` - Upload new OS images
* `POST /delete-image` - Delete images

**Use Cases:** Image management, integrity verification, automated image deployment

---

=== link:api/configuration.adoc[Configuration API]

Manage system configuration options, firmware selection for different device families, and working directory management.

**Key Endpoints:**

* `GET /options/get` - Retrieve all configuration values
* `POST /options/set` - Update configuration
* `POST /options/clear-workdir` - Clear working directory contents
* `GET /options/firmware` - List available firmware versions
* `POST /options/firmware/set` - Set firmware version
* `GET /options/firmware/notes/{version}` - Get firmware release notes

**Use Cases:** Configuration management, firmware updates, system administration

---

=== link:api/audit.adoc[Audit Log API]

Access security audit logs that track all system access, file operations, and sensitive actions. Supports filtering by event type, date range, and includes detailed client information.

**Key Endpoints:**

* `GET /auditlog` - Query audit logs with filtering

**Use Cases:** Security monitoring, compliance auditing, incident investigation

---

=== link:api/websockets.adoc[WebSocket APIs]

Real-time bidirectional communication for device topology updates and long-running operations like SHA256 hash calculations.

**Key Endpoints:**

* `WS /ws/devices` - Real-time device topology and provisioning status
* `WS /ws/sha256` - Real-time SHA256 calculation progress

**Use Cases:** Live dashboards, progress monitoring, real-time device tracking

---

=== link:api/errors.adoc[Error Handling & Content Negotiation]

Standard error response format used across all endpoints, plus information about content negotiation between JSON and HTML responses.

**Topics Covered:**

* Standard error response format
* HTTP status codes
* Error codes and meanings
* Content negotiation (`Accept` header handling)

**Use Cases:** Error handling in client applications, debugging API issues

== Additional Resources

* link:config_vars.adoc[Configuration Variables] - Complete reference for all configuration options
* link:api/README.md[API Documentation Structure] - Information about how the documentation is organized

== Quick Start

For most integrations, you'll want to start with:

1. link:api/devices.adoc[Devices API] - Monitor device provisioning status
2. link:api/manufacturing.adoc[Manufacturing Database API] - Access provisioned device records
3. link:api/services.adoc[Services API] - Monitor service execution

For advanced customisation:

1. link:api/customisation.adoc[Customisation API] - Manage provisioning scripts
2. link:api/images.adoc[Images API] - Manage OS images
3. link:api/configuration.adoc[Configuration API] - System configuration
